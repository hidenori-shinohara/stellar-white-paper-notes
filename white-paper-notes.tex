\documentclass[12pt, psamsfonts]{amsart}

%-------Packages---------
\usepackage{amssymb,amsfonts}
\usepackage{semantic}
\usepackage{fullpage}
\usepackage{tikz-cd}
\usepackage{todonotes}
\usepackage{physics}
\usepackage[all,arc]{xy}
\usepackage{enumerate}
\usepackage{enumitem}
\usepackage{mathrsfs}
\usepackage{theoremref}
\usepackage{graphicx}
\usepackage[bookmarks]{hyperref}

%--------Theorem Environments--------
%theoremstyle{plain} --- default
\newtheorem{thm}{Theorem}[section]
\newtheorem{cor}[thm]{Corollary}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{conj}[thm]{Conjecture}
\newtheorem{quest}[thm]{Question}

\theoremstyle{definition}
\newtheorem{defn}[thm]{Definition}
\newtheorem{defns}[thm]{Definitions}
\newtheorem{con}[thm]{Construction}
\newtheorem{exmp}[thm]{Example}
\newtheorem{exmps}[thm]{Examples}
\newtheorem{notn}[thm]{Notation}
\newtheorem{notns}[thm]{Notations}
\newtheorem{addm}[thm]{Addendum}
\newtheorem*{exer}{Exercise}

\theoremstyle{remark}
\newtheorem{rem}[thm]{Remark}
\newtheorem{rems}[thm]{Remarks}
\newtheorem{warn}[thm]{Warning}
\newtheorem{sch}[thm]{Scholium}

\makeatletter
\makeatother
\numberwithin{equation}{section}

\bibliographystyle{plain}

\begin{document}

\title{Stellar Consensus Protocol}
\author{Hidenori Shinohara}
\maketitle

\begin{abstract}
    This is my personal notes on the Stellar consensus protocol.
    This roughly follows the structure of the white paper on https://www.stellar.org/.
\end{abstract}

\tableofcontents


\section{Basic Properties of Quorums}

\begin{defn}
    Let $V$ be a set and $Q:V \rightarrow 2^{2^V} \setminus \{ \emptyset \}$ be a function such that $\forall v \in V, \forall q \in Q(v), v \in q$.
    Then we call the pair $\ev{V, Q}$ a federated Byzantine agreement system, or FBAS for short.
\end{defn}

\begin{defn}
    Let $\ev{V, Q}$ be an FBAS\@.
    $U \subset V$ is called a quorum if and only if $\forall v \in U, \exists q \in Q(v), q \subset U$.
\end{defn}

\begin{thm}\label{union_quorums}
    In an FBAS $\ev{V, Q}$, the union of two quorums is a quorum.
\end{thm}

\begin{proof}
    Let $U_1, U_2$ be two quorums.
    Let $v \in U_1 \cup U_2$.
    Then $v \in U_i$ for $i = 1$ or $i = 2$.
    Then $q \subset U_i$ for some $q \in Q(v)$.
    Therefore, $q \subset U_1 \cup U_2$, so $U_1 \cup U_2$ is indeed a quorum.
\end{proof}

\begin{thm}
    In an FBAS $(V, Q)$, $V$ is a quorum.
\end{thm}

\begin{proof}
    For any $v \in V$, for any $q \in Q(v)$, $q \subset V$.
    Therefore, $V$ is indeed a quorum.
\end{proof}

\begin{exmp}
    One might wonder if the intersection of quorums is always a quorum.
    However, this is not true in general.

    Let $V = \{ v_1, \ldots, v_4 \}$ and
    \begin{itemize}
        \item
            $Q(v_1) = \{ \{ v_1, v_2, v_3 \}, \{ v_1, v_2, v_4 \}, \{ v_1, v_3, v_4 \} \}$,
        \item
            $\vdots$
        \item
            $Q(v_4) = \{ \{ v_1, v_2, v_4 \}, \{ v_1, v_3, v_4 \}, \{ v_2, v_3, v_4 \} \}$.
    \end{itemize}

    In other words, $Q(v_i) = \{ U \mid U \in 2^V, v_i \in U \}$.

    Then $U_1 = \{ v_1, v_2, v_3 \}$ is a quorum, and $U_2 = \{ v_2, v_3, v_4 \}$ is a quorum.
    However, $U_1 \cap U_2 = \{ v_2, v_3 \}$ is not a quorum because the size of any quorum slice is 3.
\end{exmp}

\begin{defn}
    Let $\ev{V, Q}$ be an FBAS\@.
    We say $\ev{V, Q}$ enjoys quorum intersection if and only if for any pair of quorums $U_1, U_2$, $U_1 \cap U_2 \ne \emptyset$.
\end{defn}

\begin{defn}\label{delete_fbas}
    Let $\ev{V, Q}$ be an FBAS and $B \subset V$.
    Then the FBAS $\ev{V, Q}^B$ is defined to be $\ev{V \setminus B, Q^B}$ where $\forall v \in V, Q^B(v) = \{ q \setminus B \mid q \in Q(v) \}$.
\end{defn}

\begin{thm}
    Definition~\ref{delete_fbas} is well-defined.
    In other words, if $\ev{V, Q}$ is an FBAS and $B \subset V$, then $\ev{V, Q}^B$ is an FBAS\@.
\end{thm}

\begin{proof}
    Let $v \in V \setminus B, q' \in Q^B(v)$ be given.
    Then $q' = q \setminus B$ for some $q \in Q(v)$.
    By the definition of an FBAS, $v \in q$.
    Since $v \notin B$, $v \in q \setminus B = q'$.
    Therefore, $\ev{V, Q}^B$ is an FBAS\@.
\end{proof}

\begin{thm}\label{quorum_intersection_projected_system}
    Let $U$ be a quorum in FBAS $\ev{V, Q}$, let $B \subset V$ be a set of nodes, and let $U' = U \setminus B$.
    If $U' \ne \emptyset$, then $U'$ is a quorum in $\ev{V, Q}^B$.
\end{thm}

\begin{proof}
    Since $U' \ne \emptyset$, it suffices to show that $\forall v \in U', \exists q \in Q^B(v), q \subset U'$.
    Let $v \in U'$.
    Then $v \in U$.
    Since $U$ is a quorum in $\ev{V, Q}$, we can find $q \in Q(v)$ such that $q \subset U$.
    Then $q' = q \setminus B \in Q^B(v)$, and $q' = q \setminus B \subset U \setminus B = U'$.
    Therefore, $U'$ is a quorum in $\ev{V, Q}^B$.
\end{proof}

\begin{defn}
    Let $\ev{V, Q}$ be an FBAS and $B \subset V$ be a set of nodes.
    We say $\ev{V, Q}$ enjoys quorum intersection despite $B$ if and only if $\ev{V, Q}^B$ enjoys quorum intersection.
\end{defn}

\begin{defn}
    Let $\ev{V, Q}$ be an FBAS and $B \subset V$ be a set of nodes.
    We say $\ev{V, Q}$ enjoys quorum availability despite $B$ if and only if $V \setminus B$ is a quorum in $\ev{V, Q}$ or $B = V$.
\end{defn}

\begin{defn}
    Let $\ev{V, Q}$ be an FBAS\@.
    Let $v \in V$.
    A subset $B \subset V$ is called $v$-blocking if and only if $\forall q \in Q(v), q \cap B \ne \emptyset$.
\end{defn}

\begin{thm}\label{quorum_availability_v_blocking}
    Let $\ev{V, Q}$ be an FBAS\@.
    Let $B \subset V$.
    $\ev{V, Q}$ enjoys quorum availability despite $B$ if and only if $B$ is not $v$-blocking for any $v \in V \setminus B$.
\end{thm}

\begin{proof}
    \begin{align*}
        \forall v \in V \setminus B, \neg(\text{$B$ is $v$-blocking})
            &\iff \forall v \in V \setminus B, \neg(\forall q \in Q(v), q \cap B \ne \emptyset) \\
            &\iff \forall v \in V \setminus B, \exists q \in Q(v), q \cap B = \emptyset \\
            &\iff \forall v \in V \setminus B, \exists q \in Q(v), q \subset V \setminus B \\
            &\iff \text{$V = B$ or $V \setminus B$ is a quorum in $\ev{V, Q}$} \\
            &\iff \text{$\ev{V, Q}$ enjoys quorum availability despite $B$}
    \end{align*}
\end{proof}

\section{Dispensable Sets}

\begin{defn}\label{def_dset}
    Let $\ev{V, Q}$ be an FBAS and $B \subset V$ be a set of nodes.
    $B$ is called a dispensable set, or DSet, if and only if $\ev{V, Q}$ enjoys quorum intersection and availability despite $B$.
\end{defn}

\begin{defn}\label{def_intact_befouled}
    Let $\ev{V, Q}$ be an FBAS and $v \in V$.
    $v$ is said to be intact if and only if there exists a DSet $B$ containing all ill-behaved nodes and $v \notin B$.
    $v$ is said to be befouled if and only if $v$ is not intact.
\end{defn}

\begin{thm}\label{intersection_dset}
    If $B_1$ and $B_2$ are DSets in an FBAS $\ev{V, Q}$ enjoying quorum intersection, then $B = B_1 \cap B_2$ is a DSet, too.
\end{thm}

\begin{proof}
	If $B_1 = V$ or $B_2 = V$, then we are done.
	Suppose otherwise.

	For any $v \in V$,

	\begin{align*}
	  v \in V \setminus B
		&\iff v \in V \land v \notin B \\
		&\iff v \in V \land (v \notin B_1 \lor v \notin B_2) \\
		&\iff (v \in V \land v \notin B_1) \lor (v \in V \land v \notin B_2) \\
		&\iff (v \in (V \setminus B_1)) \lor (v \in (V \setminus B_2)) \\
		&\iff v \in ((V \setminus B_1) \cup (V \setminus B_2)).
	\end{align*}

	Thus, $V \setminus B = (V \setminus B_1) \cup (V \setminus B_2)$.
	By the definition of a DSet, $V \setminus B_1$ and $V \setminus B_2$ are both quorums in $\ev{V, Q}$.
	By Theorem~\ref{union_quorums}, $V \setminus B$ is a quorum in $\ev{V, Q}$.

	We must now show quorum intersection despite $B$.
	Let $U_a, U_b$ be quorums in $\ev{V, Q}^B$.

	\begin{itemize}
		\item
            $U_a \setminus B_1$ is a quorum in ${(\ev{V, Q}^B)}^{B_1} = \ev{V, Q}^{B_1}$ by Theorem~\ref{delete_fbas}.
		\item
			Similarly, $U_b \setminus B_1$ is a quorum in $\ev{V, Q}^{B_1}$, and $U_a \setminus B_2$ and $U_b \setminus B_2$ are both quorums in $\ev{V, Q}^{B_2}$.
	\end{itemize}

	\begin{align*}
	  (U_a \setminus B_1) \cup (U_a \setminus B_2)
		&= U_a \setminus (B_1 \cap B_2) \\
		&= U_a \setminus B \\
		&= U_a
	\end{align*}

	because $U_a$ is a quorum in $\ev{V, Q}^B$.
	In other words, $(U_a \setminus B_1) \cup (U_a \setminus B_2) \ne \emptyset$.
	Similarly, $(U_b \setminus B_1) \cup (U_b \setminus B_2) \ne \emptyset$.

	Without loss of generality, assume that $U_a \setminus B_1 \ne \emptyset$.
	\begin{itemize}
		\item
			$V \setminus B_1$ is a quorum in $\ev{V, Q}$ because $B_1$ is a DSet.
			Similarly, $V \setminus B_2$ is a quorum in $\ev{V, Q}$.
			Because $\ev{V, Q}$ enjoys quorum intersection, $(V \setminus B_1) \cap (V \setminus B_2) \ne \emptyset$.
			In other words, $(V \setminus B_2) \setminus B_1$ is a quorum.
			By Theorem~\ref{delete_fbas}, $(V \setminus B_2) \setminus B_1$ is a quorum in $\ev{V, Q}^{B_1}$.
		\item
            $U_a \setminus B_1$ is a quorum in ${(\ev{V, Q}^B)}^{B_1} = {\ev{V, Q}}^{B_1}$ for the same reason.
	\end{itemize}
	Because $B_1$ is a DSet in $\ev{V, Q}$, $\ev{V, Q}^{B_1}$ enjoys quorum intersection.
	Therefore, $(U_a \setminus B_1) \cap ((V \setminus B_2) \setminus B_1) \ne \emptyset$.
	\begin{align*}
	  (U_a \setminus B_1) \cap ((V \setminus B_2) \setminus B_1)
		&= (U_a \cap (V \setminus B_2)) \setminus B_1 \\
		&\subset U_a \cap (V \setminus B_2) \\
		&= (U_a \cap V) \setminus B_2 \\
		&= U_a \setminus B_2.
	\end{align*}
	Thus, $U_a \setminus B_2 \ne \emptyset$.
	Using the same argument, we can show that $U_b \setminus B_1 \ne \emptyset$ and $U_b \setminus B_2 \ne \emptyset$.
	Since $U_a \setminus B_1$ and $U_b \setminus B_1$ are quorums in $\ev{V, Q}^{B_1}$ and $B_1$ is a DSet, $(U_a \setminus B_1) \cap (U_b \setminus B_1) \ne \emptyset$ by the definition of a DSet.
	This implies $(U_a \cap U_b) \setminus B_1 \ne \emptyset$.
	Therefore, $U_a \cap U_b \ne \emptyset$.
\end{proof}

\begin{thm}\label{befouled_dset}
	In an FBAS with quorum intersection, the set of befouled nodes is a DSet.
\end{thm}

\begin{proof}
	Let $\ev{V, Q}$ be an FBAS with quorum intersection.
	Let $B$ be the intersection of all DSets that contain all ill-behaved nodes.
	By Theorem~\ref{intersection_dset}, $B$ is a DSet.

	\begin{itemize}
		\item
			Case 1: $v \in B$.
			Then there exists no DSet $B_v$ such that $B_v$ contains all ill-behaved nodes and $v \notin B_v$.
			Therefore, $v$ is not an intact node.
			In other words, $v$ is a befouled node.
		\item
			Case 2: $v \notin B$.
			Then there exists a DSet $B_v$ that contains all ill-behaved nodes and $v \notin B_v$.
			In other words, $v$ is intact and thus $v$ is not a befouled node.
	\end{itemize}

	Therefore, $B$ is precisely the set of befouled nodes and it is a DSet.
\end{proof}

\begin{thm}\label{dset_v_blocking}
    Let $\ev{V, Q}$ be an FBAS and let $B \subset V$ be the set of befouled nodes.
    If $B$ is a DSet, $B$ is not $v$-blocking for any intact $v$.
\end{thm}

\begin{proof}
    By Definition~\ref{def_intact_befouled}, a node $v \in V$ is intact if and only if $v \notin B$.
    By Theorem~\ref{quorum_availability_v_blocking}, $\ev{V, Q}$ enjoys quorum availability despite $B$ if and only if $B$ is not $v$-blocking for any $v \in V \setminus B$.
    Since $B$ is a DSet, $\ev{V, Q}$ enjoys quorum availability despite $B$.
    Thus $B$ is not $v$-blocking for any intact $v$.
\end{proof}

\section{Voting, Accepting, and Ratifying}

\begin{defn}\label{def_vote}
    A node $v$ votes for a statement $a$ if and only if $v$ asserts
    \begin{itemize}
        \item
            $a$ is valid,
        \item
            $a$ is consistent with all statements $v$ has accepted,
        \item
            $v$ has never voted against $a$,
        \item
            $v$ promises never to vote against $a$ in the future.
    \end{itemize}
\end{defn}

\begin{defn}\label{def_accept}
    Let $\ev{V, Q}$ be an FBAS\@, and let $v \in V$.
    $v$ accepts a statement $a$ if and only if 
    \begin{itemize}
        \item
            It has never accepted a statement contradicting $a$.
        \item
            It determines that either
            \begin{itemize}
                \item
                    There exists a quorum such that $v \in U$ and each member of $U$ either voted for $a$ or told $v$ that it has accepted $a$, or
                \item
                    There exists a $v$-blocking set $B$ such that every member of $B$ told $v$ that it has accepted $a$.
            \end{itemize}
    \end{itemize}
\end{defn}

Note that it is possible for a node to accept a statement it did not vote for.
Furthermore, it is possible for a node to accept a statement after voting for a contradictory statement.

\begin{defn}
    A quorum $U_a$ ratifies a statement $a$ if and only if every member of $U_a$ votes for $a$.
    A node $v$ ratifies $a$ if and only if $v$ is a member of a quorum $U_a$ that ratifies $a$.
\end{defn}

\begin{thm}
    If an FBAS enjoys quorum intersection and contains no ill-behaved node, then two contradictory statements cannot be both ratified.
\end{thm}

\begin{proof}
    Suppose the statement is false and let $a, \bar{a}$ denote two contradictory statements ratified in such an FBAS\@.
    Let $U_a, U_{\bar{a}}$ denote quorums ratifying such statements, respectively.
    By the definition of quorum intersection, $U_a \cap U_{\bar{a}} \ne \emptyset$.
    Let $v \in U_a \cap U_{\bar{a}}$.
    This implies that $v$ voted for both $a$ and $\bar{a}$.
    However, this goes against the definition of voting.
    In other words, $v$ must be ill-behaved, which is a contradiction to our assumption.
\end{proof}

\begin{thm}\label{ill_behaved_ratify}
    Let $\ev{V, Q}$ be an FBAS\@.
    Let $B \subsetneq V$ be a subset containing all the ill-behaved nodes and suppose that $\ev{V, Q}^B$ enjoys quorum intersection.
    Let $v_1 \ne v_2 \in V \setminus B$.
    If $v_1$ ratifies a statement $a$, then $v_2$ cannot ratify any statement that contradicts $a$.
\end{thm}

\begin{proof}
    Suppose that the theorem is false and let $U_1, U_2$ be quorums of $v_1, v_2$ that ratify $a, \bar{a}$, respectively where $a$ and $\bar{a}$ are contradictory.
    Since $v_1 \in U_1 \setminus B$,  $U_1 \setminus B \ne \emptyset$.
    By Theorem~\ref{quorum_intersection_projected_system}, $U_1' = U_1 \setminus B$ is a quorum in $\ev{V, Q}^B$.
    Similarly, $U_2' = U_2 \setminus B$ is a quorum in $\ev{V, Q}^B$.
    Since $\ev{V, Q}^B$ enjoys quorum intersection, $U_1' \cap U_2' \ne \emptyset$.
    Let $v \in U_1' \cap U_2'$.
    Then $v \in U_1 \cap U_2$.
    In order for $U_1, U_2$ to ratify $a, \bar{a}$, respectively, $v$ must vote for both $a$ and $\bar{a}$.
    However, this is against the definition of voting.
    $v$ must be an ill-behaved node, so $v \in B$, which is a contradiction because $v \in U_1 \setminus B$.
\end{proof}

\begin{thm}\label{intact_ratify_contradictory}
    Let $\ev{V, Q}$ be an FBAS with quorum intersection.
    Then two intact nodes in $V$ cannot ratify contradictory statements.
\end{thm}

\begin{proof}
    Let $v \ne v'$ be two intact nodes in $V$.
    Let $B \subset V$ be the set of befouled nodes.
    Then $v \notin B$ and $v' \notin B$.
    Since $\ev{V, Q}$ is an FBAS with quorum intersection, $B$ is a DSet by Theorem~\ref{befouled_dset}.
    By the definition of a DSet (Definition~\ref{def_dset}), $\ev{V, Q}^B$ enjoys quorum intersection.
    By Theorem~\ref{ill_behaved_ratify}, $v, v'$ cannot ratify contradictory statements.
\end{proof}

\begin{lem}\label{lem_intact_ratify}
    Let $\ev{V, Q}$ be an FBAS enjoying quorum intersection and $B$ be the set of befouled nodes.
    If $a$ is accepted by an intact node in $V$, then $a$ is ratified by some intact node in $\ev{V, Q}^B$.
\end{lem}

\begin{proof}
    Since $V$ is finite, there has to be an intact node $v$ such that no intact nodes in $V$ accepted $a$ before $v$.

    Since $\ev{V, Q}$ enjoys quorum intersection, $B$ is a DSet by Theorem~\ref{befouled_dset}.
    By Theorem~\ref{dset_v_blocking}, $B$ is not $v$-blocking.
    Therefore, by Definition~\ref{def_accept}, there must exist a quorum $U$ of $v$ such that, before $v$ accepted $a$, every member of $U$ either voted for $a$ or told $v$ that it has accepted $a$.
    Because of the way we picked $v$, every intact node in $U$ must have voted for $a$ before $v$ accepted $a$.
    In other words, every node in $U \setminus B$ voted for $a$.
    By Theorem~\ref{quorum_intersection_projected_system}, $v$ ratified $a$ in ${\ev{V, Q}}^B$.
    Finally, $v$ is indeed an intact node in ${\ev{V, Q}}^B$ because ${\ev{V, Q}}^B$ contains no ill-behaved nodes.
\end{proof}

\begin{thm}
    Two intact nodes in an FBAS $\ev{V, Q}$ enjoying quorum intersection cannot accept contradictory statements.
\end{thm}

\begin{proof}
    Suppose otherwise.
    Let $a, \bar{a}$ be contradictory statements accepted by two intact nodes in $\ev{V, Q}$.
    By Lemma~\ref{lem_intact_ratify}, $a, \bar{a}$ are ratified by some intact nodes in $\ev{V, Q}^B$.
    By Definition~\ref{def_dset}, $\ev{V, Q}$ enjoys quorum intersection despite $B$.
    In other words, $\ev{V, Q}^B$ enjoys quorum intersection.
    By Theorem~\ref{intact_ratify_contradictory}, $a, \bar{a}$ cannot be ratified by $v, v'$ in $\ev{V, Q}^B$, which is a contradiction.
\end{proof}

\end{document}
